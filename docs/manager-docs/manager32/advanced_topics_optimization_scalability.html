<!doctype html>
<html lang="en">

<!-- head -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Optimization and Scalability</title>
    <meta name="description" content="This site generates SUSE documentation using jekyll, asciidoc, travis and github.">
    <meta name="author" content="Your name goes here">
    <meta name="copyright" content="Maybe consider a Creative Commons license">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://use.fontawesome.com/abbdb82656.js"></script>

    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="assets/css/coderay.css">
    <link rel="stylesheet" href="assets/css/asciidoctor.css">

    <div class="content"><nav class="navbar navbar-toggleable-md navbar-light" style="background-color: #EDEDED;">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="#">SUSE Live Documentation (ALPHA)</a>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="https://jcayouette.github.io/suse-publisher/index.html">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Disabled</a>
            </li>
        </ul>
        <div id="navigation">
<input type="text" id="search-box" />
</div>
          <!--
        <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search" id="search-box">

            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button> -->
        </form>
    </div>
</nav>
</div>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Arvo|Bitter|Copse|Cutive|Lora:700|Sanchez|Scope+One|Slabo+27px|Trocchi|Vesper+Libre" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">


</head>


<body class="landing-page">
<!-- Top most navbar -->


<!-- Page Content -->
<div class="container">
    <div class="post-header">
    <h1 class="post-title-main">Optimization and Scalability</h1>
</div>
<div id="search-box">
  <!-- SearchBox widget will appear here -->
</div>

<div id="hits">
  <!-- Hits widget will appear here -->
</div>

<script>
  const search = instantsearch(options);

  // initialize SearchBox
  search.addWidget(
    instantsearch.widgets.searchBox({
      container: '#search-box',
      placeholder: 'Search for products'
    })
  );

  // initialize hits widget
  search.addWidget(
    instantsearch.widgets.hits({
      container: '#hits'
    })
  );

  search.start();
</script>

<!-- If this does not work place post-content back in div and remove article -->
<div class="post-content">
    <!-- HACK enough for the demo lol -->
    

    
      <a target="_blank" href="https://github.com/jcayouette/example-manager-docs/edit/master/docs/manager-docs/manager32/advanced_topics_optimization_scalability.adoc" class="btn btn-primary" role="button"> Edit me</a>
    

    <!-- page content -->
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_optimizing.apache_tomcat">1. Optimizing Apache and Tomcat</a>
<ul class="sectlevel2">
<li><a href="#apaches_httpd_maxclients_parameter">1.1. Apache&#8217;s httpd MaxClients Parameter</a></li>
<li><a href="#tomcats_maxthreads_parameter">1.2. Tomcat&#8217;s maxThreads Parameter</a></li>
</ul>
</li>
<li><a href="#_optimizing.big">2. Big Scale Deployment (1000 Minions or More)</a>
<ul class="sectlevel2">
<li><a href="#_optimizing.big.general">2.1. General Recommendations</a></li>
<li><a href="#_optimizing.big.tuning">2.2. Tuning Proposals</a></li>
</ul>
</li>
</ul>
</div>
<div class="sect1">
<h2 id="_optimizing.apache_tomcat">1. Optimizing Apache and Tomcat</h2>
<div class="sectionbody">
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Altering Apache and Tomcat Parameters</div>
<div class="paragraph">
<p>Apache and Tomcat Parameters should only be modified with support or consulting as these parameters can have severe and catastrophic performance impacts on your server when improperly adjusted.
SUSE will not be able to provide support for catastrophic failure when these advanced parameters are modified without consultation.
Tuning values for Apache httpd and Tomcat requires that you align these parameters with your server hardware.
Furthermore testing of these altered values should be performed within a test environment.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="apaches_httpd_maxclients_parameter">1.1. Apache&#8217;s httpd MaxClients Parameter</h3>
<div class="paragraph">
<p>The <code class="parameter">MaxClients</code> setting determines the number of Apache httpd processes, and thus limits the number of client connections that can be made at the same time (SUSE Manager uses the pre-fork MultiProcessing Modules). The default value for <code class="parameter">MaxClients</code> in SUSE Manager is 150.
If you need to set the <code class="parameter">MaxClients</code> value greater than 150, Apache httpd&#8217;s ServerLimit setting and Tomcat&#8217;s <code class="parameter">maxThreads</code> must also be increased accordingly (see below).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The Apache httpd <code class="parameter">MaxClients</code> parameter must always be less or equal than Tomcat&#8217;s <code class="parameter">maxThreads</code> parameter!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If the <code class="parameter">MaxClients</code> value is reached while the software is running, new client connections will be queued and forced to wait, this may result in timeouts.
You can check the Apache httpd&#8217;s <code class="path">error.log</code>
 for details:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>[error] Server reached MaxClients setting, consider increasing the MaxClients setting</pre>
</div>
</div>
<div class="paragraph">
<p>The default <code class="parameter">MaxClients</code> parameter can be overridden on SUSE Manager by editing the <code class="path">server-tuning.conf</code>
 file located at <code class="systemitem">/etc/apache2/</code>
.</p>
</div>
<div class="paragraph">
<p>Example <code class="path">server-tuning.conf</code>
 file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># prefork MPM
   &lt;IfModule prefork.c&gt;
           # number of server processes to start
           # http://httpd.apache.org/docs/2.2/mod/mpm_common.html#startservers
           StartServers         5
           # minimum number of server processes which are kept spare
           # http://httpd.apache.org/docs/2.2/mod/prefork.html#minspareservers
           MinSpareServers      5
           # maximum number of server processes which are kept spare
           # http://httpd.apache.org/docs/2.2/mod/prefork.html#maxspareservers
           MaxSpareServers     10
           # highest possible MaxClients setting for the lifetime of the Apache process.
           # http://httpd.apache.org/docs/2.2/mod/mpm_common.html#serverlimit
           ServerLimit        150
           # maximum number of server processes allowed to start
           # http://httpd.apache.org/docs/2.2/mod/mpm_common.html#maxclients
           MaxClients         150
           # maximum number of requests a server process serves
           # http://httpd.apache.org/docs/2.2/mod/mpm_common.html#maxrequestsperchild
           MaxRequestsPerChild  10000
   &lt;/IfModule&gt;</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="tomcats_maxthreads_parameter">1.2. Tomcat&#8217;s maxThreads Parameter</h3>
<div class="paragraph">
<p>Tomcat&#8217;s <code class="parameter">maxThreads</code> represents the maximum number of request processing threads that it will create.
This value determines the maximum number of simultaneous requests that it is able to handle.
All HTTP requests to the SUSE Manager server (from clients, browsers, XMLRPC API scripts, etc.) are handled by Apache httpd, and some of them are routed to Tomcat for further processing.
It is thus important that Tomcat is able to serve the same amount of simultaneous requests that Apache httpd is able to serve in the worst case.
The default value for SUSE Manager is 200 and should always be equal or greater than Apache httpd&#8217;s <code class="parameter">MaxClients</code>.
The <code class="parameter">maxThreads</code> value is located within the <code class="path">server.xml</code>
 file located at <code class="systemitem">/etc/tomcat/</code>
.</p>
</div>
<div class="paragraph">
<p>Example relevant lines in <code class="path">server.xml</code>
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" URIEncoding="UTF-8" address="127.0.0.1" maxThreads="200" connectionTimeout="20000"/&gt;
&lt;Connector port="8009" protocol="AJP/1.3" redirectPort="8443" URIEncoding="UTF-8" address="::1" maxThreads="200" connectionTimeout="20000"/&gt;</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Tuning Notes</div>
<div class="paragraph">
<p>When configuring Apache httpd&#8217;s <code class="parameter">MaxClients</code> and Tomcat&#8217;s <code class="parameter">maxThreads</code> parameters you should also take into consideration that each HTTP connection will need one or more database connections.
If the RDBMS is not able to serve an adequate amount of connections, issues will arise.
See the following equation for a rough calculation of the needed amount of database connections:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>((3 * java_max) +  apache_max + 60)</pre>
</div>
</div>
<div class="paragraph">
<p>Where:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>3 is the number of Java processes the server runs with pooled connections (Tomcat, Taskomatic and Search)</p>
</li>
<li>
<p>java_max is the maximum number of connections per Java pool (20 by default, changeable in <code class="path">/etc/rhn/rhn.conf</code> via the hibernate.c3p0.max_size parameter)</p>
</li>
<li>
<p>apache_max is Apache httpd&#8217;s <code class="parameter">MaxClients</code></p>
</li>
<li>
<p>60 is the maximum expected number of extra connections for local processes and other uses</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_optimizing.big">2. Big Scale Deployment (1000 Minions or More)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the following sections find considerations about a big scale deployment.
In this context, a big scale compromises 1000 minions or more.</p>
</div>
<div class="sect2">
<h3 id="_optimizing.big.general">2.1. General Recommendations</h3>
<div class="paragraph">
<p>{suse}
recommends the following in a big scale {susemgr}
deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>{susemgr} servers should have at least 8 recent {x86} cores, 32 GiB of RAM, and, most important, fast I/O devices such as at least an SSD (2 SSDs in RAID-0 are strongly recommended).</p>
</li>
<li>
<p>Proxies with many minions (hundreds) should have at least 2 recent {x86} cores and 16 GiB of RAM.</p>
</li>
<li>
<p>Use one {susemgrproxy} per 500-1000 clients. Keep into account that download time depends on network capacity. Here is a rough example calculation with physical link speed of 1 GB/s:</p>
<div class="listingblock">
<div class="content">
<pre>400 Megabytes  *        3000       /      119 Megabyte/s        / 60
= 169 Minutes</pre>
</div>
</div>
<div class="paragraph">
<p>This is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Size of updates * Number of minions / Theoretical download speed / 60</pre>
</div>
</div>
</li>
<li>
<p>Depending on hardware you can accept hundreds of minion keys.</p>
</li>
<li>
<p>Plan time for onboarding minions{mdash} at least one hour per 1000 minions.</p>
</li>
<li>
<p>It is not recommended onboarding more than approx. 1000 minions directly to the {susemgr} server{mdash} proxies should be used instead. This is because every minion can use up to 3 TCP connections simultaneously, and too many TCP connections can cause performance issues.</p>
</li>
<li>
<p>If the following error appears in output of <code class="command">dmesg</code>, you probably have an excessive number of minions attached to a single {susemgr} server or proxy for the ARP cache to contain all of their addresses:</p>
<div class="listingblock">
<div class="content">
<pre>kernel: neighbour table overflow</pre>
</div>
</div>
<div class="paragraph">
<p>In that case, increase the ARP cache values via <code class="systemitem">sysctl</code>
, for example, by adding the following lines to <code class="path">/etc/sysctl.conf</code>
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>net.ipv4.neigh.default.gc_thresh1 = 4096
net.ipv4.neigh.default.gc_thresh2 = 8192
net.ipv4.neigh.default.gc_thresh3 = 16384
net.ipv4.neigh.default.gc_interval = 60
net.ipv4.neigh.default.gc_stale_time = 120</pre>
</div>
</div>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Start Small and Scale Up</div>
<div class="paragraph">
<p>Always start small and scale up gradually.
Keep the server monitored in order to identify possible issues early.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_optimizing.big.tuning">2.2. Tuning Proposals</h3>
<div class="paragraph">
<p>{suse}
proposes the following tuning settingsin a big scale {susemgr}
deployment:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Increase Tomcat memory to face a long queue of Salt return results. Items in the Salt return queue might accumulate in a short time: Set 8 GiB instead of the current default 1 GiB.</p>
</li>
<li>
<p>Several RHN parameters should be changed from their defaults:</p>
<div class="ulist">
<ul>
<li>
<p>The number of Taskomatic workers should be increased, and thus parallelizing work on a high number of separate jobs (onboarding, staging).</p>
</li>
<li>
<p>Quartz should check for runnable jobs more frequently to reduce latency (onboarding, staging, Action execution).</p>
</li>
<li>
<p>Tomcat&#8217;s Salt return result workers should be increased, and thus parallelizing work on a high number of Salt return results (patching).</p>
</li>
<li>
<p>The number of PostgreSQL connections available to Java applications (Tomcat, Taskomatic) should increase accordingly. Otherwise extra workers will starve waiting for a connection.</p>
</li>
<li>
<p>Salt&#8217;s presence ping timeouts should be increased because responses might come back later than the defaults.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Salt master worker threads should be increased to 100 from 15, and thus parallelizing more requests (otherwise Tomcat and Taskomatic workers will starve waiting for the API to do something).</p>
</li>
<li>
<p>Increasing the number of Salt master worker threads more requires more RAM and does not bring benefits. Apache maximum request time should be increased.</p>
</li>
</ul>
</div>
</div>
</div>
</div>


</div>
<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'WNURXD2O78',
  indexName: 'suse-publisher',
  apiKey: '761b121f117dc5882bfa9e6b1a7abd88'
});

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-box',
    placeholder: 'Search in documents...',
    poweredBy: true // This is required if you're on the free Community plan
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits'
  })
);

// Starting the search
search.start();
</script>


</div>


<!-- Footer -->

<footer class="row">

</footer>

<!-- <script src="js/vendor/jquery.js"></script>
<script src="js/foundation.min.js"></script>
<script>
    $(document).foundation();
    var doc = document.documentElement;
    doc.setAttribute('data-useragent', navigator.userAgent);
</script>-->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'WNURXD2O78',
  indexName: 'suse-publisher',
  apiKey: '761b121f117dc5882bfa9e6b1a7abd88'
});

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-box',
    placeholder: 'Search in documents...',
    poweredBy: true // This is required if you're on the free Community plan
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits'
  })
);

// Starting the search
search.start();
</script>

</body>
</html>
