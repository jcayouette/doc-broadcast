<!doctype html>
<html lang="en">

<!-- head -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>Salt Formulas and {susemgr}</title>
    <meta name="description" content="This site generates SUSE documentation using jekyll, asciidoc, travis and github.">
    <meta name="author" content="Your name goes here">
    <meta name="copyright" content="Maybe consider a Creative Commons license">

    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <script src="https://use.fontawesome.com/abbdb82656.js"></script>

    <link rel="stylesheet" href="assets/css/custom.css">
    <link rel="stylesheet" href="assets/css/coderay.css">
    <link rel="stylesheet" href="assets/css/asciidoctor.css">

    <div class="content"><nav class="navbar navbar-toggleable-md navbar-light" style="background-color: #EDEDED;">
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <a class="navbar-brand" href="#">SUSE Live Documentation (ALPHA)</a>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href="https://jcayouette.github.io/suse-publisher/index.html">Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item">
                <a class="nav-link disabled" href="#">Disabled</a>
            </li>
        </ul>
        <div id="navigation">
<input type="text" id="search-box" />
</div>
          <!--
        <form class="form-inline my-2 my-lg-0">
            <input class="form-control mr-sm-2" type="text" placeholder="Search" id="search-box">

            <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button> -->
        </form>
    </div>
</nav>
</div>

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Arvo|Bitter|Copse|Cutive|Lora:700|Sanchez|Scope+One|Slabo+27px|Trocchi|Vesper+Libre" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Barlow" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">


</head>


<body class="landing-page">
<!-- Top most navbar -->


<!-- Page Content -->
<div class="container">
    <div class="post-header">
    <h1 class="post-title-main">Salt Formulas and {susemgr}</h1>
</div>
<div id="search-box">
  <!-- SearchBox widget will appear here -->
</div>

<div id="hits">
  <!-- Hits widget will appear here -->
</div>

<script>
  const search = instantsearch(options);

  // initialize SearchBox
  search.addWidget(
    instantsearch.widgets.searchBox({
      container: '#search-box',
      placeholder: 'Search for products'
    })
  );

  // initialize hits widget
  search.addWidget(
    instantsearch.widgets.hits({
      container: '#hits'
    })
  );

  search.start();
</script>

<!-- If this does not work place post-content back in div and remove article -->
<div class="post-content">
    <!-- HACK enough for the demo lol -->
    

    
      <a target="_blank" href="https://github.com/jcayouette/example-manager-docs/edit/master/docs/manager-docs/manager32/bp_chap_getting_started_with_salt_formulas.adoc" class="btn btn-primary" role="button"> Edit me</a>
    

    <!-- page content -->
    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_best.practice.salt.formulas.what">1. What are Salt Formulas?</a></li>
<li><a href="#_best.practice.salt.formulas.install">2. Installing Salt Formulas via RPM</a></li>
<li><a href="#_best.practice.salt.formulas.filedir">3. File Structure Overview</a></li>
<li><a href="#_best.practice.salt.formulas.pillar">4. Editing Pillar Data in {susemgr}</a>
<ul class="sectlevel2">
<li><a href="#_salt.formulas.ex.edit_group">4.1. Simple <code>edit-group</code> Example</a></li>
</ul>
</li>
<li><a href="#_best.practice.salt.formulas.writing">5. Writing Salt Formulas</a></li>
<li><a href="#_best.practice.salt.formulas.data">6. Separating Data</a></li>
<li><a href="#_best.practice.salt.formulas.pillardata">7. {susemgr} Generated Pillar Data</a></li>
<li><a href="#_best.practice.salt.formulas.req">8. Formula Requirements</a></li>
<li><a href="#_best.practice.salt.formulas.using">9. Using Salt Formulas with {susemgr}</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This chapter provides an introduction for using Salt Formulas with {susemgr}
.
Creation of custom formulas will also be introduced.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.what">1. What are Salt Formulas?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formulas are collections of Salt States that have been pre-written by other Salt users and contain generic parameter fields.
Formulas allow for reliable reproduction of a specific configuration again and again.
Formulas can be installed from RPM packages or an external git repository.</p>
</div>
<div class="paragraph">
<p>The following list will help you in making the decision to use a state or a formula.</p>
</div>
<div class="ulist">
<div class="title">Formula Tips</div>
<ul>
<li>
<p>When writing states for trivial tasks, formulas are probably not worth the time investment.</p>
</li>
<li>
<p>For large, non-trivial configurations use formulas.</p>
</li>
<li>
<p>Formulas and States both act as a kind of configuration documentation. Once written and stored you will have a snapshot of what your infrastructure should look like.</p>
</li>
<li>
<p>You can greatly decrease the amount of time required for writing a formula by grabbing one of the many pre-written formulas on github. There are pre-written formulas for hundreds of configurations. You can find these located at <a href="https://github.com/saltstack-formulas" class="bare">https://github.com/saltstack-formulas</a>.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.install">2. Installing Salt Formulas via RPM</h2>
<div class="sectionbody">
<div class="paragraph">
<p>{suse}
releases formulas as RPM packages.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Formula Channel Location</div>
<div class="paragraph">
<p>Available formulas can be located within the <code class="systemitem">SUSE-Manager-Server-3.2-Pool</code>
 channel.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="olist arabic">
<div class="title">Procedure: Installing Salt Formulas from an RPM</div>
<ol class="arabic">
<li>
<p>To search for available formulas, execute the following command on your {susemgr} server:</p>
<div class="listingblock">
<div class="content">
<pre>{prompt.root}
zypper se formula</pre>
</div>
</div>
<div class="paragraph">
<p>You will be presented with a list of available Salt formulas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>S | Name              | Summary                                                    | Type
--+-------------------+------------------------------------------------------------+-----------
  | locale-formula    | Locale Salt Formula for SUSE Manager                       | package
  | locale-formula    | Locale Salt Formula for SUSE Manager                       | srcpackage</pre>
</div>
</div>
</li>
<li>
<p>For more information (metadata) about a specific formula run from the command line:</p>
<div class="listingblock">
<div class="content">
<pre>{prompt.root}
zypper info locale-formula</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>Information for package locale-formula:
-----------------------------------------
Repository: SUSE-Manager-Server-{productnumber}
-Pool
Name:  locale-formula
Version:  0.2-1.1
Arch: noarch
Vendor:  SUSE LLC &lt;https://www.suse.com/&gt;
Support Level: Level 3
Status: not installed
Installed Size: 47.9 KiB
Installed: No
Source package : locale-formula-0.2-1.1.src
Summary        : Locale Salt Formula for SUSE Manager
Description    : Salt Formula for SUSE Manager. Sets up the locale.</pre>
</div>
</div>
</li>
<li>
<p>To install a formula, as {rootuser} or with <code class="command">sudo</code> run:</p>
<div class="listingblock">
<div class="content">
<pre>{prompt.root}
zypper in locale-formula</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.filedir">3. File Structure Overview</h2>
<div class="sectionbody">
<div class="paragraph">
<p>RPM-based formulas need to be placed within a specific directory structure to ensure proper functionality.
A formula always consists of two separate directories: The <code class="path">states</code>
 directory and the <code class="path">metadata</code>
 directory.
Folders in these directories need to have an exactly matching name, for example <code>locale</code>.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The Formula State Directory</dt>
<dd>
<p>The formula states directory contains anything necessary for a Salt state to work independently.
This includes <code class="path">.sls</code>
files, a <code class="path">map.jinja</code>
file and any other required files.
This directory should only be modified by RPMs and should not be edited manually.
For example, the <span class="package">locale-formula</span>
states directory is located in:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/formulas/states/locale/</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">The Formula Metadata Directory</dt>
<dd>
<p>The metadata directory contains a <code class="path">form.yml</code>
file which defines the forms for {susemgr}
and an optional <code class="path">metadata.yml</code>
file that can contain additional information about a formula.
For example, the <span class="package">locale-formula</span>
metadata directory is located in:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/formulas/metadata/locale/</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Custom Formulas</dt>
<dd>
<p>Custom formula data or (non-RPM) formulas need to be placed into any state directory configured as a Salt file root:</p>
</dd>
<dt class="hdlist1">State directory</dt>
<dd>
<p>Custom state formula data need to be placed in:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>/srv/salt/custom/</pre>
</div>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Metadata Directory</dt>
<dd>
<p>Custom metadata (information) need to be placed in:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>/srv/formula_metadata/custom/</pre>
</div>
</div>
<div class="paragraph">
<p>All custom folders located in the following directories needs to contain a <code class="path">form.yml</code>
 file.
These files are detected as form recipes and may be applied to groups and systems from the {webui}
:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/srv/salt/formula_metadata/`custom-formula-name`
/form.yml</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.pillar">4. Editing Pillar Data in {susemgr}</h2>
<div class="sectionbody">
<div class="paragraph">
<p>{susemgr}
requires a file called <code class="path">form.yml</code>
, to describe how formula data should look within the {webui}
. <code class="path">form.yml</code>
 is used by {susemgr}
 to generate the desired form, with values editable by a user.</p>
</div>
<div class="paragraph">
<p>For example, the <code class="path">form.yml</code>
 that is included with the <span class="package">locale-formula</span>
 is placed in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/formulas/metadata/locale/form.yml</pre>
</div>
</div>
<div class="paragraph">
<p>See part of the following <span class="package">locale-formula</span>
 example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre># This file is part of locale-formula.
#
# Foobar is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# Foobar is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with Foobar.  If not, see &lt;http://www.gnu.org/licenses/&gt;.

timezone:
  $type: group

  name:
    $type: select
    $values: ["CET",
              "CST6CDT",
              "EET",
              "EST",
              "EST5EDT",
              "GMT",
              "GMT+0",
              "GMT-0",
              "GMT0",
              "Greenwich",
              "HST",
              "MET",
              "MST",
              "MST7MDT",
              "NZ",
              "NZ-CHAT",
              "Navajo",
              "PST8PDT",
              "UCT",
              "UTC",
              "Universal",
              "W-SU",
              "WET",
              "Zulu",
              "Etc/GMT+1",
              "Etc/GMT+2",
              "Etc/GMT+3",
              "Etc/GMT+4",
              "Etc/GMT+5",
              "Etc/GMT+6",
              "Etc/GMT+7",
              "Etc/GMT+8",
              "Etc/GMT+9",
              "Etc/GMT+10",
              "Etc/GMT+11",
              "Etc/GMT+12",
              "Etc/GMT-1",
              "Etc/GMT-2",
              "Etc/GMT-3",
              "Etc/GMT-4",
              "Etc/GMT-5",
              "Etc/GMT-6",
              "Etc/GMT-7",
              "Etc/GMT-8",
              "Etc/GMT-9",
              "Etc/GMT-10",
              "Etc/GMT-11",
              "Etc/GMT-12",
              "Etc/GMT-13",
              "Etc/GMT-14",
              "Etc/GMT",
              "Etc/GMT+0",
              "Etc/GMT-0",
              "Etc/GMT0",
              "Etc/Greenwich",
              "Etc/UCT",
              "Etc/UTC",
              "Etc/Universal",
              "Etc/Zulu"
              ]
    $default: CET

  hardware_clock_set_to_utc:
    $type: boolean
    $default: True
...</pre>
</div>
</div>
<div class="paragraph">
<p><code class="path">form.yml</code>
 contains additional information that describes how the form for a pillar should look for {susemgr}
.
This information is contained in attributes that always start with a <code>$</code> sign.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Ignored Values</div>
<div class="paragraph">
<p>All values that start with a <code>$</code> sign are annotations used to display the UI that users interact with.
These annotations are not part of pillar data itself and are handled as metadata.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The following are valid attributes.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">$type</dt>
<dd>
<p>The most important attribute is the <code>$type</code> attribute.
It defines the type of the pillar value and the form-field that is generated.
The following represent the supported types:</p>
<div class="ulist">
<ul>
<li>
<p><code>text</code></p>
</li>
<li>
<p><code>password</code></p>
</li>
<li>
<p><code>number</code></p>
</li>
<li>
<p><code>url</code></p>
</li>
<li>
<p><code>email</code></p>
</li>
<li>
<p><code>date</code></p>
</li>
<li>
<p><code>time</code></p>
</li>
<li>
<p><code>datetime</code></p>
</li>
<li>
<p><code>boolean</code></p>
</li>
<li>
<p><code>color</code></p>
</li>
<li>
<p><code>select</code></p>
</li>
<li>
<p><code>group</code></p>
</li>
<li>
<p><code>edit-group</code></p>
</li>
<li>
<p><code>namespace</code></p>
</li>
<li>
<p><code>hidden-group</code> (obsolete, renamed to <code>namespace</code>)</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Text Attribute</div>
<div class="paragraph">
<p>The text attribute is the default and does not need to be specified explicitly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>+
Many of these values are self-explanatory: <code>text</code> will generate a simple text field, <code>password</code> a password field and the <code>color</code> type will generate a color picker.</p>
</div>
<div class="paragraph">
<p>+
The <code>group</code>, <code>edit-group</code>, and <code>namespace</code> (formerly <code>hidden-group</code>) types do not generate an editable field and are used to structure form and pillar data.
The difference between <code>group</code> and <code>namespace</code> is <code>group</code> generates a visible border with a heading, and <code>namespace</code> shows nothing visually (and is only used to structure pillar data).  The difference between <code>group</code> and <code>edit-group</code> is <code>edit-group</code> allows to structure and restrict editable fields in a more flexible way.
For example, <code>edit-group</code> supports the <code>$minItems</code> and <code>$maxItems</code> attributes, and thus it simplifies complex and repeatable input structures.
For an <code>edit-group</code> example, see <a href="#_salt.formulas.ex.edit_group">Simple <code>edit-group</code> Example</a>.</p>
</div>
</dd>
<dt class="hdlist1">$default</dt>
<dd>
<p><code>$default</code> allows you to specify a default value that is displayed and used, if no other value is entered.
In an <code>edit-group</code> it allows to create inital members of the group and populate them with specified data.</p>
</dd>
<dt class="hdlist1">$name</dt>
<dd>
<p><code>$name</code> allows you to specify the name of a value that is shown in the form.
If this value is not set, the pillar name is used and capitalized without underscores and dashes.
You reference it in the same section with <code>${name}</code>.</p>
</dd>
<dt class="hdlist1">$help and $placeholder</dt>
<dd>
<p>The <code>$help</code> and <code>$placeholder</code> attributes are used to give a user a better understanding of what the value should be. <code>$help</code> defines the message a user sees when hovering over a field and <code>$placeholder</code> displays a gray placeholder text in the field. <code>$placeholder</code> may only be used with text fields like text, password, email or date.
It does not make sense to add a placeholder if you also use <code>$default</code> as this will hide the placeholder.</p>
</dd>
<dt class="hdlist1">$minItems and $maxItems</dt>
<dd>
<p>In an <code>edit-group</code>, <code>$minItems</code> and <code>$maxItems</code> allow you to specify the lowest and highest number the group can occur.</p>
</dd>
<dt class="hdlist1">$itemName</dt>
<dd>
<p>In an <code>edit-group</code>, <code>$itemName</code> allows to define a template for the name to be used for the members of the group.</p>
</dd>
<dt class="hdlist1">$prototype</dt>
<dd>
<p>In an <code>edit-group</code>, <code>$prototype</code> allows to define default (or pre-filled) values for newly added members in the group.</p>
</dd>
<dt class="hdlist1">$scope</dt>
<dd>
<p><code>$scope</code> allows you to specify a hierarchy level at which a value may be edited.
Possible values are <code>system</code>, <code>group</code> and <code>readonly</code>.</p>
<div class="paragraph">
<p>The default <code>$scope: system</code> allows values to be edited at group and system levels.
A value can be entered for each system but if no value is entered the system will fall back to the group default.</p>
</div>
<div class="paragraph">
<p>If using <code>$scope: group</code>, a value may only be edited for a group.
On the system level you will be able to see the value, but not edit it.</p>
</div>
<div class="paragraph">
<p>The <code>$scope: readonly</code> option makes a field read-only.
It can be used to show a user data which should be known, but should not be editable.
This option only makes sense in combination with the $default attribute.</p>
</div>
</dd>
<dt class="hdlist1">$visibleIf</dt>
<dd>
<p><code>$visibleIf</code> allows you to show a field or group if a simple condition is met.
A condition always looks similar to the following example:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>some_group$another_group$my_checkbox == true</pre>
</div>
</div>
<div class="paragraph">
<p>+
The left part of the above statement is the path to another value, and groups are separated by <code>$</code> signs.
The middle section of the command should be either <code>==</code> for a value to be equal or <code>!=</code> for values that should be not equal.
The last field in the statement can be any value which a field should have or not have.</p>
</div>
<div class="paragraph">
<p>+
The field with this attribute associated with it will now be shown only when the condition is met.
In this example the field will be shown only if <code>my_checkbox</code> is checked.
The ability to use conditional statements is not limited to check boxes.
It may also be used to check values of select-fields, text-fields etc.</p>
</div>
<div class="paragraph">
<p>+
A check box should be structured like the following example:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre>some_group:
  $type: group

  another_group:
    $type: group

      my_checkbox:
        $type: boolean</pre>
</div>
</div>
<div class="paragraph">
<p>+
By using multiple groups with the attribute, you can allow a user to select an option and show a completely different form, dependant upon the selected value.</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Hidden Values</div>
<div class="paragraph">
<p>Values from hidden fields may be merged into the pillar data and sent to the minion.
A formula must check the condition again and use the appropriate data.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>show_option:
  $type: checkbox
some_text:
  $visibleIf: show_option == true</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>{% if pillar.show_option %}
do_something:
  with: {{ pillar.some_text }}
{% endif %}</pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">$values</dt>
<dd>
<p><code>$values</code> can only be used together with <code>$type</code>: select to specify the different options in the select-field. <code>$values</code> must be a list of possible values to select.
For example:</p>
</dd>
</dl>
</div>
<div class="listingblock">
<div class="content">
<pre>select_something:
  $type: select
  $values: [“option1”, “option2”]</pre>
</div>
</div>
<div class="paragraph">
<p>+
Or alternatively:</p>
</div>
<div class="paragraph">
<p>+</p>
</div>
<div class="listingblock">
<div class="content">
<pre>select_something:
  $type: select
  $values:
    - option1
    - option2</pre>
</div>
</div>
<div class="sect2">
<h3 id="_salt.formulas.ex.edit_group">4.1. Simple <code>edit-group</code> Example</h3>
<div id="_ex.salt.formula.edit_group" class="exampleblock">
<div class="title">Example 1. Defining Hard Disk Partitions with <code>edit-group</code></div>
<div class="content">
<div class="listingblock">
<div class="content">
<pre>partitions:
  $name: "Hard Disk Partitions"
  $type: "edit-group"
  $minItems: 1
  $maxItems: 4
  $itemName: "Partition ${name}"
  $prototype:
    name:
      $default: "New partition"
    mountpoint:
      $default: "/var"
    size:
      $type: "number"
      $name: "Size in GB"
  $default:
    - name: "Boot"
      mountpoint: "/boot"
    - name: "Root"
      mountpoint: "/"
      size: 5000</pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>After clicking <span class="menuseq"><b class="menu">Add</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu">]
 for one time you will see &lt;&lt;_fig_formula_custom_harddisk_partitions</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="submenu"></b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">filled with the default values.
The formula itself is called <code class="path">hd-partitions</code>
 and will appear as menu:Hd Partitions[</b></span>
 in the {webui}
.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="formula-custom-harddisk-partitions.png" alt="formula custom harddisk partitions">
</div>
<div class="title">Figure 1. <code>edit-group</code> Example in the {webui} <a id="_fig_formula_custom_harddisk_partitions"></a></div>
</div>
<div class="paragraph">
<p>To remove definition of a partition click the minus symbol in the title line of an inner group.
When form fields are properly filled confirm with clicking <b class="menuref">Save Formula</b>
 in the upper right corner of the formula.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.writing">5. Writing Salt Formulas</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Salt formulas are pre-written Salt states, which may be configured with pillar data.
You can parametrize state files using Jinja.
Jinja allows you to access pillar data by using the following syntax.
(This syntax works best when your uncertain a pillar value exists as it will throw an error):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>pillar.some.value</pre>
</div>
</div>
<div class="paragraph">
<p>When you are sure a pillar exists may also use the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>salt['pillar.get']('some:value', 'default value')</pre>
</div>
</div>
<div class="paragraph">
<p>You may also replace the <code>pillar</code> value with <code>grains</code> (for example, <code>grains.some.value</code>) allowing access to grains.</p>
</div>
<div class="paragraph">
<p>Using data this way allows you to make a formula configurable.
The following code snippet will install a package specified in the pillar <code>package_name</code>.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>install_a_package:
  pkg.installed:
    - name: {{ pillar.package_name }}</pre>
</div>
</div>
<div class="paragraph">
<p>You may also use more complex constructs such as <code>if/else</code> and <code>for-loops</code> To provide greater functionality.
For Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% if pillar.installSomething %}
something:
  pkg.installed
{% else %}
anotherPackage:
  pkg.installed
{% endif %}</pre>
</div>
</div>
<div class="paragraph">
<p>Another example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% for service in pillar.services %}
start_{{ service }}:
  service.running:
    - name: {{ service }}
{% endfor %}</pre>
</div>
</div>
<div class="paragraph">
<p>Jinja also provides other helpful functions.
For example, you can iterate over a dictionary:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% for key, value in some_dictionary.items() %}
do_something_with_{{ key }}: {{ value }}
{% endfor %}</pre>
</div>
</div>
<div class="paragraph">
<p>You may want to have Salt manage your files (for example, configuration files for a program), and you can change these with pillar data.
For example, the following snippet shows how you can manage a file using Salt:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/etc/my_program/my_program.conf:
  file.managed:
    - source: salt://my_state/files/my_program.conf
    - template: jinja</pre>
</div>
</div>
<div class="paragraph">
<p>Salt will copy the file <code class="path">salt-file_roots/my_state/files/my_program.conf</code>
 on the salt master to <code class="path">/etc/my_program/my_program.conf</code>
 on the minion and template it with Jinja.
This allows you to use Jinja in the file, exactly like shown above for states:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>some_config_option = {{ pillar.config_option_a }}</pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.data">6. Separating Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is often a good idea to separate data from a state to increase its flexibility and add re-usability value.
This is often done by writing values into a separate file named <code class="path">map.jinja</code>
.
This file should be placed within the same directory as your state files.</p>
</div>
<div class="paragraph">
<p>The following example will set <code>data</code> to a dictionary with different values, depending on which system the state runs on.
It will also merge data with the pillar using the <code>some.pillar.data</code> value so you can access <code>some.pillar.data.value</code> by just using <code>data.value</code>.</p>
</div>
<div class="paragraph">
<p>You can also choose to override defined values from pillars (for example, by overriding <code>some.pillar.data.package</code> in the example).</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% set data = salt['grains.filter_by']({
    'Suse': {
        'package': 'packageA',
        'service': 'serviceA'
    },
    'RedHat': {
        'package': 'package_a',
        'service': 'service_a'
    }
}, merge=salt['pillar.get']('some:pillar:data')) %}</pre>
</div>
</div>
<div class="paragraph">
<p>After creating a map file like the above example, you can easily maintain compatibility with multiple system types while accessing "deep" pillar data in a simpler way.
Now you can import and use <code>data</code> in any file.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% from "some_folder/map.jinja" import data with context %}

install_package_a:
  pkg.installed:
    - name: {{ data.package }}</pre>
</div>
</div>
<div class="paragraph">
<p>You can also define multiple variables by copying the <code>{% set &#8230;&#8203;
   %}</code> statement with different values and then merge it with other pillars.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% set server = salt['grains.filter_by']({
    'Suse': {
        'package': 'my-server-pkg'
    }
}, merge=salt['pillar.get']('myFormula:server')) %}
{% set client = salt['grains.filter_by']({
    'Suse': {
        'package': 'my-client-pkg'
    }
}, merge=salt['pillar.get']('myFormula:client')) %}</pre>
</div>
</div>
<div class="paragraph">
<p>To import multiple variables, separate them with a comma.
For Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>{% from "map.jinja" import server, client with context %}</pre>
</div>
</div>
<div class="paragraph">
<p>Formulas utilized with {susemgr}
should follow formula conventions listed in the official documentation: <a href="https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html" class="bare">https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.pillardata">7. {susemgr} Generated Pillar Data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When pillar data is generated (for example, after applying the highstate) the following external pillar script generates pillar data for packages, group ids, etc.
and includes all pillar data for a system:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/modules/pillar/suma_minion.py</pre>
</div>
</div>
<div class="paragraph">
<p>The process is executed as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The <code>suma_minion.py</code> script starts and finds all formulas for a system (by checking the <code>group_formulas.json</code> and <code>server_formulas.json</code> files).</p>
</li>
<li>
<p><code>suma_minion.py</code> loads the values for each formula (groups and from the system) and merges them with the highstate (default: if no values are found, a group overrides a system if $scope: group etc.).</p>
</li>
<li>
<p><code>suma_minion.py</code> also includes a list of formulas applied to the system in a pillar named formulas. This structure makes it possible to include states. The top file (in this case specifically generated by the <code>mgr_master_tops.py</code> script) includes a state called formulas for each system. This includes the <code>formulas.sls</code> file located in:</p>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/formulas/states/</pre>
</div>
</div>
<div class="paragraph">
<p>The content looks similar to the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>include: {{ pillar["formulas"] }}</pre>
</div>
</div>
<div class="paragraph">
<p>This pillar includes all formulas, that are specified in pillar data generated from the external pillar script.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.req">8. Formula Requirements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Formulas should be designed/created directly after a {susemgr}
installation, but if you encounter any issues check the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The external pillar script (<code>suma_minion.py</code>) must include formula data.</p>
</li>
<li>
<p>Data is saved to <code class="path">/srv/susemanager/formula_data</code> and the <code class="path">pillar</code> and <code class="path">group_pillar</code> sub-directories. These should be automatically generated by the server.</p>
</li>
<li>
<p>Formulas must be included for every minion listed in the top file. Currently this process is initiated by the <code class="path">mgr_master_tops.py</code> script which includes the formulas.sls file located in:</p>
<div class="listingblock">
<div class="content">
<pre>/usr/share/susemanager/formulas/states/</pre>
</div>
</div>
<div class="paragraph">
<p>This directory must be a salt file root.
File roots are configured on the salt-master ({susemgr}
) located in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>/etc/salt/master.d/susemanager.conf</pre>
</div>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_best.practice.salt.formulas.using">9. Using Salt Formulas with {susemgr}</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The following procedure provides an overview on using Salt Formulas with {susemgr}
.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Official formulas may be installed as RPMs. If you have written your own formulas, place the states within <code class="path">/srv/salt/your-formula-name/</code> and the metadata (<code class="path">form.yml</code> and <code class="path">metadata.yml</code> ) in <code class="path">/srv/formula_metadata/your-formula-name/</code> . After installing your formulas they will appear in <span class="menuseq"><b class="menu">Salt</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">Formula Catalog</b></span> .</p>
</li>
<li>
<p>To begin using a formula, apply it to a group or system. Apply a formula to a group or system by selecting the <span class="menuseq"><b class="menu">Formulas</b>&#160;<i class="fa fa-angle-right caret"></i> <b class="menuitem">] tab of a system&#8217;s details page or system group. From the menu:Formulas[</b></span> page you can select any formulas you wish to apply to a group or system. Click the <b class="menuref">Save</b> button to save your changes to the database.</p>
</li>
<li>
<p>After applying one or more formulas to a group or system, additional tabs will become available from the top menu, one for each formula selected. From these tabs you may configure your formulas.</p>
</li>
<li>
<p>When you have finished customizing your formula values you will need to apply the highstate for them to take effect. Applying the highstate will execute the state associated with the formula and configure targeted systems. You can use the <b class="menuref">Apply Highstate</b> button from any formulas page of a group.</p>
</li>
<li>
<p>When a change to any of your values is required or you need to re-apply the formula state because of a failure or bug, change values located on your formula pages and re-apply the highstate. Salt will ensure that only modified values are adjusted and restart or reinstall services only when necessary.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This conclude your introduction to Salt Formulas.
For additional information, see <a href="https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html" class="bare">https://docs.saltstack.com/en/latest/topics/development/conventions/formulas.html</a>.</p>
</div>
</div>
</div>


</div>
<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'WNURXD2O78',
  indexName: 'suse-publisher',
  apiKey: '761b121f117dc5882bfa9e6b1a7abd88'
});

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-box',
    placeholder: 'Search in documents...',
    poweredBy: true // This is required if you're on the free Community plan
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits'
  })
);

// Starting the search
search.start();
</script>


</div>


<!-- Footer -->

<footer class="row">

</footer>

<!-- <script src="js/vendor/jquery.js"></script>
<script src="js/foundation.min.js"></script>
<script>
    $(document).foundation();
    var doc = document.documentElement;
    doc.setAttribute('data-useragent', navigator.userAgent);
</script>-->
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<!-- Including InstantSearch.js library and styling -->
<script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.6.0/dist/instantsearch-theme-algolia.min.css">

<script>
// Instanciating InstantSearch.js with Algolia credentials
const search = instantsearch({
  appId: 'WNURXD2O78',
  indexName: 'suse-publisher',
  apiKey: '761b121f117dc5882bfa9e6b1a7abd88'
});

// Adding searchbar and results widgets
search.addWidget(
  instantsearch.widgets.searchBox({
    container: '#search-box',
    placeholder: 'Search in documents...',
    poweredBy: true // This is required if you're on the free Community plan
  })
);
search.addWidget(
  instantsearch.widgets.hits({
    container: '#search-hits'
  })
);

// Starting the search
search.start();
</script>

</body>
</html>
